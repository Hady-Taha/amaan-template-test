<!DOCTYPE html>
<html lang="en" dir="ltr" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <title>Amman Stream Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    html, body { height: 100%; }
    .vh-100 { min-height: 100vh; }
    .ratio-16x9 { background: #000; }
  </style>
</head>

<body class="bg-black text-light d-flex flex-column align-items-center justify-content-center vh-100">
  <div class="container text-center">
    <h2 class="mb-4">ðŸŽ¬ <span style="color:#6351ff;">Amman</span> Stream Player</h2>

    <!-- Inputs -->
    <div class="row justify-content-center g-3">
      <div class="col-12 col-md-6">
        <label for="videoUid" class="form-label">Video UID</label>
        <input
          id="videoUid"
          type="text"
          class="form-control text-center"
          placeholder="Enter Video UUID (e.g., 6fc1e036-114a-4fb2-a6dd-f68150af497e)"
        />
      </div>
      <div class="col-12 col-md-6">
        <label for="apiKey" class="form-label">API Key</label>
        <input
          id="apiKey"
          type="text"
          class="form-control text-center"
          value="easytech_85b719d6-775a-40f9-b236-3a9b02398af1"
        />
      </div>
    </div>

    <button id="generateBtn" class="btn btn-primary px-4 mt-3">Generate OTP &amp; Play</button>
    <div id="status" class="mt-3 text-info"></div>

    <!-- Player -->
    <div class="py-5 d-flex justify-content-center align-items-center w-100">
      <div class="ratio ratio-16x9" style="max-width: 720px; width: 100%;">
        <iframe
          id="videoFrame"
          allow="autoplay; fullscreen; encrypted-media"
          sandbox="allow-scripts allow-same-origin allow-forms allow-popups"
          style="border:none; display:none;"
          title="Amman DRM Player"
        ></iframe>
      </div>
    </div>
  </div>

  <script>
    // --- Constants ---
    const AMMAN_BACKEND_ORIGIN = "https://test.easy-stream.net"; // iframe origin
    const OTP_ENDPOINT_BASE = `${AMMAN_BACKEND_ORIGIN}/api/video/generate-otp`; // POST /:uid/
    const PLAYER_PAGE_URL = `${AMMAN_BACKEND_ORIGIN}/api/video/player/`;       // ?otp=&playbackInfo=
    const STATIC_WID = "01030265229"; // viewer id (unchanged)

    // --- DOM ---
    const $uid = document.getElementById("videoUid");
    const $key = document.getElementById("apiKey");
    const $btn = document.getElementById("generateBtn");
    const $status = document.getElementById("status");
    const $iframe = document.getElementById("videoFrame");

    // --- Helpers ---
    const setStatus = (msg, cls = "text-info") => {
      $status.className = `mt-3 ${cls}`;
      $status.textContent = msg;
    };

    async function generateOtp(uid, apiKey) {
      const url = `${OTP_ENDPOINT_BASE}/${encodeURIComponent(uid)}/`;
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Authorization": `api-key ${apiKey}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ wid: STATIC_WID })
      });
      if (!res.ok) throw new Error(`Server returned ${res.status}`);
      return res.json(); // { otp, playbackInfo }
    }

    function buildPlayerSrc(otp, playbackInfo) {
      const params = new URLSearchParams({
        otp: otp,
        playbackInfo: playbackInfo
      });
      return `${PLAYER_PAGE_URL}?${params.toString()}`;
    }

    // --- Main action ---
    $btn.addEventListener("click", async () => {
      const uid = ($uid.value || "").trim();
      const apiKey = ($key.value || "").trim();

      if (!uid) return setStatus("âš ï¸ Please enter a video UID.", "text-warning");
      if (!apiKey) return setStatus("âš ï¸ Please enter an API key.", "text-warning");

      setStatus("â³ Generating OTP...");
      $iframe.style.display = "none";
      $iframe.removeAttribute("src"); // reset previous player

      try {
        const { otp, playbackInfo } = await generateOtp(uid, apiKey);
        const src = buildPlayerSrc(otp, playbackInfo);
        $iframe.src = src;
        $iframe.style.display = "block";
        setStatus("âœ… Video loaded successfully!", "text-success");
      } catch (err) {
        console.error(err);
        setStatus(`âŒ Error: ${err.message}`, "text-danger");
      }
    });

    // --- Console logger for ALL Amaan events (no logic changes) ---
    function logEvt(name, data) {
      const ts = new Date().toISOString();
      console.log(`[AMAAN EVT] ${ts} :: ${name}`, data ?? "");
    }

    window.addEventListener("message", (e) => {
      // Only accept messages from the backend iframe
      if (e.origin !== AMMAN_BACKEND_ORIGIN) return;

      const { type, payload } = e.data || {};
      if (!type || !type.startsWith("amaan:")) return;

      switch (type) {
        case "amaan:ready":
          console.log("[AMAAN READY]", payload?.state);
          break;

        case "amaan:evt": {
          const { evt, data } = payload || {};
          // This prints: play, pause, time, duration, seeking, volume, mute, unmute,
          // quality, subtitle, speed, buffering, buffered, fullscreen, error, ended, etc.
          logEvt(evt, data);
          break;
        }

        case "amaan:resp":
          // Only relevant if you later send commands from parent to child
          console.log("[AMAAN RESP]", payload);
          break;

        default:
          console.log("[AMAAN UNKNOWN]", e.data);
      }
    });
  </script>
</body>
</html>
